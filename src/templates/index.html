<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>XMRT-DAO Ecosystem Dashboard | Eliza Command Center</title>

  <!-- External stylesheet (no embedded CSS). Adjust filename if needed -->
  <link rel="stylesheet" href="/static/css/styles.css" />

  <!-- Basic favicon safety -->
  <link rel="icon" href="/static/favicon.ico" />
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <h1>XMRT-DAO Ecosystem Dashboard</h1>
      </div>
      <div class="status-indicator">
        <div class="status-dot" aria-hidden="true"></div>
        <span id="global-status-text">Checking systems…</span>
      </div>
    </div>
  </header>

  <!-- Hero Section with Featured Calculator -->
  <section class="hero-section">
    <div class="hero-content">
      <h1 class="hero-title">MobileMonero Mining Calculator</h1>
      <p class="hero-subtitle">
        Calculate potential earnings from mobile Monero mining with advanced hardware upgrades and real-time network data
      </p>

      <!-- Featured Calculator -->
      <div class="dashboard-section calculator-section">
        <div class="section-header">
          <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M22 7 13.5 15.5 8.5 10.5 2 17M16 7 22 7 22 13"/>
          </svg>
          <h2 class="section-title">Advanced Mining Calculator</h2>
        </div>

        <div class="calculator-content">
          <div class="calculator-header">
            <p class="calculator-description">Optimize your mobile mining strategy with real-time calculations</p>
          </div>

          <div class="calculator-controls">
            <div class="control-group">
              <div class="control-header">
                <label class="control-label" for="hashrate-slider">Average Hashrate per Device</label>
                <span id="hashrate-value" class="control-value">600 H/s</span>
              </div>
              <input type="range" id="hashrate-slider" min="200" max="1200" value="600" class="slider" />
              <div class="slider-labels">
                <span>200 H/s</span><span>1,200 H/s</span>
              </div>
            </div>

            <div class="control-group">
              <div class="control-header">
                <label class="control-label" for="devices-slider">Number of Mining Devices</label>
                <span id="devices-value" class="control-value">100</span>
              </div>
              <!-- keep 1..1000 then log-scale to 1..1,000,000 -->
              <input type="range" id="devices-slider" min="1" max="1000" value="100" class="slider" />
              <div class="slider-labels"><span>1</span><span>1M</span></div>
            </div>

            <div class="control-group">
              <div class="control-header">
                <label class="control-label" for="uptime-slider">Mining Uptime per Day</label>
                <span id="uptime-value" class="control-value">24 hrs</span>
              </div>
              <input type="range" id="uptime-slider" min="1" max="24" value="24" class="slider" />
              <div class="slider-labels"><span>1 hr</span><span>24 hrs</span></div>
            </div>

            <div class="control-group">
              <div class="control-header">
                <label class="control-label" for="xmr-price-slider">Monero (XMR) Price</label>
                <span id="xmr-price-value" class="control-value">$265</span>
              </div>
              <input type="range" id="xmr-price-slider" min="50" max="1000" value="265" class="slider" />
              <div class="slider-labels"><span>$50</span><span>$1,000</span></div>
            </div>
          </div>

          <div class="upgrade-section">
            <h4 class="upgrade-title">Hardware Upgrades</h4>
            <div class="toggle-container">
              <label for="advanced-processors-toggle" class="toggle-label">Advanced Processors (2.5x Hashrate)</label>
              <label class="toggle-switch">
                <input type="checkbox" id="advanced-processors-toggle" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="toggle-container">
              <label for="solid-state-battery-toggle" class="toggle-label">Solid State Batteries (+25% Uptime)</label>
              <label class="toggle-switch">
                <input type="checkbox" id="solid-state-battery-toggle" />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>

          <div class="calculator-stats">
            <div class="stat-card">
              <div id="total-hashrate" class="stat-value stat-purple">—</div>
              <div class="stat-label">Total Hashrate</div>
            </div>
            <div class="stat-card">
              <div id="network-share" class="stat-value stat-blue">—</div>
              <div class="stat-label">Network Share</div>
            </div>
            <div class="stat-card">
              <div id="xmr-price-display" class="stat-value stat-green">—</div>
              <div class="stat-label">XMR Price</div>
            </div>
            <div class="stat-card">
              <div id="network-hashrate" class="stat-value stat-yellow">—</div>
              <div class="stat-label">Network Hashrate</div>
            </div>
          </div>

          <div class="earnings-section">
            <h4 class="earnings-title">
              <svg class="earnings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
              Projected Earnings
            </h4>
            <div class="earnings-grid">
              <div class="earnings-card earnings-daily">
                <div id="daily-xmr" class="earnings-xmr">—</div>
                <div id="daily-usd" class="earnings-usd">—</div>
                <div class="earnings-period">Daily</div>
              </div>
              <div class="earnings-card earnings-monthly">
                <div id="monthly-xmr" class="earnings-xmr">—</div>
                <div id="monthly-usd" class="earnings-usd">—</div>
                <div class="earnings-period">Monthly</div>
              </div>
              <div class="earnings-card earnings-yearly">
                <div id="yearly-xmr" class="earnings-xmr">—</div>
                <div id="yearly-usd" class="earnings-usd">—</div>
                <div class="earnings-period">Yearly</div>
              </div>
            </div>
          </div>

          <div class="disclaimer">
            <p><strong>Disclaimer:</strong> Estimates based on current network conditions. Actual earnings vary with difficulty, price, and device performance.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Dashboard Container -->
  <div class="dashboard-container">
    <!-- Dashboard Metrics Section -->
    <section class="dashboard-metrics">
      <!-- System Overview -->
      <div class="dashboard-section">
        <div class="section-header">
          <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          <h2 class="section-title">System Overview</h2>
        </div>

        <div class="system-status">
          <div class="status-item status-online"><span>Eliza Agent</span></div>
          <div class="status-item status-online"><span>Mining Service</span></div>
          <div class="status-item status-online"><span>MESHNET</span></div>
          <div class="status-item status-online"><span>Health Monitor</span></div>
        </div>

        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-value metric-primary" id="uptime">—</div>
            <div class="metric-label">System Uptime</div>
            <div class="metric-trend trend-up" id="uptime-trend">→</div>
          </div>
          <div class="metric-card">
            <div class="metric-value metric-success" id="response-time">—</div>
            <div class="metric-label">Avg Response Time</div>
            <div class="metric-trend trend-stable" id="rt-trend">→</div>
          </div>
        </div>
      </div>

      <!-- Mining Metrics -->
      <div class="dashboard-section">
        <div class="section-header">
          <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
          <h2 class="section-title">Mining Operations</h2>
        </div>

        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-value metric-warning" id="network-hashrate-display">—</div>
            <div class="metric-label">Network Hashrate</div>
            <div class="metric-trend trend-up" id="nh-trend">→</div>
          </div>
          <div class="metric-card">
            <div class="metric-value metric-purple" id="active-miners">—</div>
            <div class="metric-label">Active Miners</div>
            <div class="metric-trend trend-up" id="am-trend">→</div>
          </div>
          <div class="metric-card">
            <div class="metric-value metric-success" id="xmr-price">$—</div>
            <div class="metric-label">XMR Price</div>
            <div class="metric-trend trend-up" id="xmr-trend">→</div>
          </div>
          <div class="metric-card">
            <div class="metric-value metric-orange" id="difficulty">—</div>
            <div class="metric-label">Network Difficulty</div>
            <div class="metric-trend trend-stable" id="diff-trend">→</div>
          </div>
        </div>

        <div class="chart-container">
          <span>Hashrate Performance Chart (Live Data)</span>
        </div>
      </div>

      <!-- MESHNET Status -->
      <div class="dashboard-section">
        <div class="section-header">
          <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/>
          </svg>
          <h2 class="section-title">MESHNET Status</h2>
        </div>

        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-value metric-primary" id="mesh-nodes">—</div>
            <div class="metric-label">Active Nodes</div>
            <div class="metric-trend trend-up" id="mn-trend">→</div>
          </div>
          <div class="metric-card">
            <div class="metric-value metric-success" id="mesh-coverage">—</div>
            <div class="metric-label">Network Coverage</div>
            <div class="metric-trend trend-up" id="mc-trend">→</div>
          </div>
        </div>

        <div class="network-viz" id="mesh-viz"></div>
      </div>

      <!-- ElizaOS Agent Status -->
      <div class="dashboard-section">
        <div class="section-header">
          <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 01-2 2z"/>
          </svg>
          <h2 class="section-title">ElizaOS Agent</h2>
        </div>

        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-value metric-success" id="agent-tasks">—</div>
            <div class="metric-label">Tasks Completed</div>
            <div class="metric-trend trend-up" id="at-trend">→</div>
          </div>
          <div class="metric-card">
            <div class="metric-value metric-primary" id="agent-memory">—</div>
            <div class="metric-label">Memory Usage</div>
            <div class="metric-trend trend-stable" id="amem-trend">→</div>
          </div>
          <div class="metric-card">
            <div class="metric-value metric-warning" id="agent-credits">—</div>
            <div class="metric-label">Credits Remaining</div>
            <div class="metric-trend trend-down" id="ac-trend">→</div>
          </div>
          <div class="metric-card">
            <div class="metric-value metric-purple" id="agent-autonomy">—</div>
            <div class="metric-label">Autonomy Status</div>
            <div class="metric-trend trend-stable" id="aa-trend">→</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Chatbot Section -->
    <aside class="chatbot-section">
      <div class="chatbot-container">
        <div class="chatbot-header">
          <div class="chatbot-title">
            <svg class="chatbot-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            <h2>Eliza Command Interface</h2>
          </div>
          <div class="chatbot-status">
            <div class="status-dot" aria-hidden="true"></div>
            <span>XMRT-DAO Autonomous Operator</span>
          </div>
        </div>

        <div class="chatbot-messages" id="messages">
          <div class="message eliza-message">
            <div class="message-content">
              Greetings. I am Eliza, the autonomous operator for the XMRT-DAO Ecosystem. My systems are online and fully operational. How may I assist you?
              <br /><br />
              Available commands: 'status', 'dashboard', 'health'.
            </div>
          </div>
        </div>

        <div class="chatbot-input">
          <input type="text" class="chat-input" id="message-input" placeholder="Enter command or ask a question..." />
          <button class="send-button" id="send-button">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
            </svg>
            Send
          </button>
        </div>
      </div>
    </aside>
  </div>

  <!-- Floating Chatbot Toggle (Desktop Only) -->
  <button class="chatbot-toggle" id="chatbot-toggle" aria-label="Toggle chat">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
    </svg>
  </button>

  <!-- Floating Chatbot (Desktop Only) -->
  <div class="chatbot-floating" id="chatbot-floating" aria-live="polite">
    <div class="chatbot-container">
      <div class="chatbot-header">
        <div class="chatbot-title">
          <svg class="chatbot-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
          </svg>
          <h2>Eliza Command Interface</h2>
        </div>
        <div class="chatbot-status">
          <div class="status-dot" aria-hidden="true"></div>
          <span>XMRT-DAO Autonomous Operator</span>
        </div>
      </div>

      <div class="chatbot-messages" id="floating-messages">
        <div class="message eliza-message">
          <div class="message-content">
            Greetings. I am Eliza, the autonomous operator for the XMRT-DAO Ecosystem. My systems are online and fully operational. How may I assist you?
            <br /><br />
            Available commands: 'status', 'dashboard', 'health'.
          </div>
        </div>
      </div>

      <div class="chatbot-input">
        <input type="text" class="chat-input" id="floating-message-input" placeholder="Enter command or ask a question..." />
        <button class="send-button" id="floating-send-button">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
          Send
        </button>
      </div>
    </div>
  </div>

  <!-- ✅ Load dashboard logic from static JS -->
  <script src="/static/js/dashboard.js"></script>

  <script>
    // -------------------------
    // API wiring (Flask Gateway)
    // -------------------------
    const API_BASE = (location.port === "8000")
      ? "" // when serving index via the Flask app itself
      : (window.__XMRT_API_BASE__ || ""); // same-origin by default; override by setting window.__XMRT_API_BASE__

    const endpoints = {
      status:       `${API_BASE}/api/v1/autonomous/status`,
      metrics:      `${API_BASE}/api/v1/metrics/performance`,
      decisions:    `${API_BASE}/api/v1/decisions/history`,
      emergency:    `${API_BASE}/api/v1/emergency/pause`,
      // Optional (if you add these on the gateway):
      // price:     `${API_BASE}/api/v1/market/xmr`,
      // mining:    `${API_BASE}/api/v1/mining/summary`,
      // meshnet:   `${API_BASE}/api/v1/meshnet/status`,
    };

    async function fetchJSON(url, fallback = null, opt = {}) {
      try {
        const res = await fetch(url, { credentials: "include", ...opt });
        if (!res.ok) throw new Error(res.status + " " + res.statusText);
        return await res.json();
      } catch (e) {
        console.warn("API fallback:", url, e);
        return fallback;
      }
    }

    // -------------------------
    // Mining Calculator (client)
    // -------------------------
    class MiningCalculator {
      constructor() {
        this.networkHashrate = 2.8e9;     // default 2.8 GH/s
        this.blockReward = 0.6;           // XMR per block
        this.blockTime = 120;             // seconds
        this.initializeElements();
        this.bindEvents();
        this.calculate();
      }
      initializeElements() {
        this.elements = {
          hashrateSlider: document.getElementById('hashrate-slider'),
          devicesSlider: document.getElementById('devices-slider'),
          uptimeSlider: document.getElementById('uptime-slider'),
          xmrPriceSlider: document.getElementById('xmr-price-slider'),
          hashrateValue: document.getElementById('hashrate-value'),
          devicesValue: document.getElementById('devices-value'),
          uptimeValue: document.getElementById('uptime-value'),
          xmrPriceValue: document.getElementById('xmr-price-value'),
          advancedProcessors: document.getElementById('advanced-processors-toggle'),
          solidStateBattery: document.getElementById('solid-state-battery-toggle'),
          totalHashrate: document.getElementById('total-hashrate'),
          networkShare: document.getElementById('network-share'),
          xmrPriceDisplay: document.getElementById('xmr-price-display'),
          networkHashrateDisplay: document.getElementById('network-hashrate'),
          dailyXmr: document.getElementById('daily-xmr'),
          dailyUsd: document.getElementById('daily-usd'),
          monthlyXmr: document.getElementById('monthly-xmr'),
          monthlyUsd: document.getElementById('monthly-usd'),
          yearlyXmr: document.getElementById('yearly-xmr'),
          yearlyUsd: document.getElementById('yearly-usd')
        };
      }
      bindEvents() {
        this.elements.hashrateSlider.addEventListener('input', e => {
          this.elements.hashrateValue.textContent = `${e.target.value} H/s`;
          this.calculate();
        });
        this.elements.devicesSlider.addEventListener('input', e => {
          const value = this.scaleDevices(parseInt(e.target.value, 10));
          this.elements.devicesValue.textContent = this.formatDevices(value);
          this.calculate();
        });
        this.elements.uptimeSlider.addEventListener('input', e => {
          this.elements.uptimeValue.textContent = `${e.target.value} hrs`;
          this.calculate();
        });
        this.elements.xmrPriceSlider.addEventListener('input', e => {
          this.elements.xmrPriceValue.textContent = `$${e.target.value}`;
          this.calculate();
        });
        this.elements.advancedProcessors.addEventListener('change', () => this.calculate());
        this.elements.solidStateBattery.addEventListener('change', () => this.calculate());
      }
      scaleDevices(sliderValue) {
        const min = 1, max = 1_000_000;
        const minLog = Math.log(min), maxLog = Math.log(max);
        const scale = (maxLog - minLog) / 999; // slider 1..1000
        return Math.round(Math.exp(minLog + scale * (sliderValue - 1)));
      }
      formatDevices(value) {
        if (value >= 1_000_000) return `${(value / 1_000_000).toFixed(1)}M`;
        if (value >= 1_000) return `${(value / 1_000).toFixed(0)}K`;
        return String(value);
      }
      formatHashrate(h) {
        if (h >= 1e9) return `${(h / 1e9).toFixed(1)} GH/s`;
        if (h >= 1e6) return `${(h / 1e6).toFixed(1)} MH/s`;
        if (h >= 1e3) return `${(h / 1e3).toFixed(1)} KH/s`;
        return `${h.toFixed(0)} H/s`;
      }
      calculate() {
        const baseHashrate = parseInt(this.elements.hashrateSlider.value, 10);
        const devices = this.scaleDevices(parseInt(this.elements.devicesSlider.value, 10));
        const uptime = parseInt(this.elements.uptimeSlider.value, 10);
        const xmrPrice = parseInt(this.elements.xmrPriceSlider.value, 10);
        const adv = this.elements.advancedProcessors.checked;
        const ssb = this.elements.solidStateBattery.checked;

        let effectiveHashrate = adv ? baseHashrate * 2.5 : baseHashrate;
        let effectiveUptime = Math.min(24, ssb ? uptime * 1.25 : uptime);

        const totalHashrate = effectiveHashrate * devices * (effectiveUptime / 24);
        const networkShare = (totalHashrate / this.networkHashrate) * 100;

        const blocksPerDay = (24 * 3600) / this.blockTime;
        const dailyReward = this.blockReward * blocksPerDay;
        const dailyXmr = dailyReward * (networkShare / 100);
        const dailyUsd = dailyXmr * xmrPrice;

        const monthlyXmr = dailyXmr * 30, monthlyUsd = dailyUsd * 30;
        const yearlyXmr = dailyXmr * 365, yearlyUsd = dailyUsd * 365;

        this.elements.totalHashrate.textContent = this.formatHashrate(totalHashrate);
        this.elements.networkShare.textContent = `${networkShare.toFixed(4)}%`;
        this.elements.xmrPriceDisplay.textContent = `$${xmrPrice}`;
        this.elements.networkHashrateDisplay.textContent = this.formatHashrate(this.networkHashrate);

        this.elements.dailyXmr.textContent = `${dailyXmr.toFixed(4)} XMR`;
        this.elements.dailyUsd.textContent = `$${dailyUsd.toFixed(2)}`;
        this.elements.monthlyXmr.textContent = `${monthlyXmr.toFixed(2)} XMR`;
        this.elements.monthlyUsd.textContent = `${monthlyUsd.toFixed(2)}`;
        this.elements.yearlyXmr.textContent = `${yearlyXmr.toFixed(2)} XMR`;
        this.elements.yearlyUsd.textContent = `${yearlyUsd.toFixed(2)} XMR`;
      }
      setNetwork(hashrate, price) {
        if (Number.isFinite(hashrate)) this.networkHashrate = hashrate;
        if (Number.isFinite(price)) {
          this.elements.xmrPriceSlider.value = Math.max(50, Math.min(1000, Math.round(price)));
          this.elements.xmrPriceValue.textContent = `$${this.elements.xmrPriceSlider.value}`;
        }
        this.calculate();
      }
    }

    // -------------------------
    // Chatbot (local echo + hooks)
    // -------------------------
    class ElizaChatbot {
      constructor() {
        this.messages = document.getElementById('messages');
        this.floatingMessages = document.getElementById('floating-messages');
        this.messageInput = document.getElementById('message-input');
        this.floatingMessageInput = document.getElementById('floating-message-input');
        this.sendButton = document.getElementById('send-button');
        this.floatingSendButton = document.getElementById('floating-send-button');
        this.chatbotToggle = document.getElementById('chatbot-toggle');
        this.chatbotFloating = document.getElementById('chatbot-floating');
        this.bindEvents();
      }
      bindEvents() {
        this.sendButton.addEventListener('click', () => this.sendMessage());
        this.floatingSendButton?.addEventListener('click', () => this.sendMessage(true));
        this.messageInput.addEventListener('keypress', e => { if (e.key === 'Enter') this.sendMessage(); });
        this.floatingMessageInput?.addEventListener('keypress', e => { if (e.key === 'Enter') this.sendMessage(true); });
        this.chatbotToggle.addEventListener('click', () => {
          const isVisible = this.chatbotFloating.style.display === 'block';
          this.chatbotFloating.style.display = isVisible ? 'none' : 'block';
        });
      }
      addMessage(container, content, type) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}-message`;
        messageDiv.innerHTML = `<div class="message-content">${content}</div>`;
        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
      }
      async sendMessage(isFloating = false) {
        const input = isFloating ? this.floatingMessageInput : this.messageInput;
        const messagesContainer = isFloating ? this.floatingMessages : this.messages;
        const message = input.value.trim();
        if (!message) return;
        this.addMessage(messagesContainer, message, 'user');
        input.value = '';

        // Simple local commands; you can route to your backend later
        let response = this.processCommand(message);
        this.addMessage(messagesContainer, response, 'eliza');
      }
      processCommand(msg) {
        const cmd = msg.toLowerCase().trim();
        if (cmd === 'status')   return window.__xmrtStatusCache || 'Gathering status…';
        if (cmd === 'dashboard') return window.__xmrtMetricsCache || 'Gathering metrics…';
        if (cmd === 'health')   return window.__xmrtHealthCache || 'Running health checks…';
        if (cmd.includes('help')) {
          return `Commands:
• status — System status report
• dashboard — Metrics overview
• health — Health check
(Eliza can be wired to POST here for real actions.)`;
        }
        return `Command received: "${msg}". Monitoring continues.`;
      }
    }

    // -------------------------
    // Live data bootstrap
    // -------------------------
    const calc = new MiningCalculator();
    const bot  = new ElizaChatbot();

    async function hydrateFromAPI() {
      // Status
      const status = await fetchJSON(endpoints.status, null);
      if (status) {
        document.getElementById('global-status-text').textContent = status?.overall || 'All Systems Operational';
        window.__xmrtStatusCache =
          `System Status:
• Eliza: ${status.eliza?.state ?? 'UNKNOWN'}
• Mining: ${status.mining?.state ?? 'UNKNOWN'}
• MESHNET: ${status.meshnet?.nodes ?? '?'} nodes
• Health: ${status.health ?? 'OK'}
• Uptime: ${status.uptime ?? '—'}`;
        // Example agent fields if provided
        if (status.agent) {
          setText('agent-autonomy', status.agent.autonomy ?? '—');
          setText('agent-credits',  status.agent.credits ?? '—');
          setText('agent-memory',   status.agent.memory_usage ?? '—');
          setText('agent-tasks',    status.agent.tasks_completed ?? '—');
        }
      } else {
        document.getElementById('global-status-text').textContent = 'Status service unavailable';
      }

      // Metrics
      const metrics = await fetchJSON(endpoints.metrics, null);
      if (metrics) {
        setText('uptime',           metrics.uptime_percent ? `${metrics.uptime_percent.toFixed(2)}%` : '—');
        setText('response-time',    metrics.avg_response_ms ? `${Math.round(metrics.avg_response_ms)}ms` : '—');
        setText('network-hashrate-display', formatMaybeHashrate(metrics.network_hashrate_hs));
        setText('active-miners',    metrics.active_miners ?? '—');
        setText('xmr-price',        metrics.xmr_price_usd ? `$${Number(metrics.xmr_price_usd).toFixed(2)}` : '$—');
        setText('difficulty',       metrics.network_difficulty ?? '—');

        // Push network hashrate/price into calculator defaults
        calc.setNetwork(Number(metrics.network_hashrate_hs), Number(metrics.xmr_price_usd));

        window.__xmrtMetricsCache =
`Dashboard:
• Network Hashrate: ${formatMaybeHashrate(metrics.network_hashrate_hs)}
• Active Miners: ${metrics.active_miners ?? '—'}
• XMR Price: ${metrics.xmr_price_usd ? `$${Number(metrics.xmr_price_usd).toFixed(2)}` : '$—'}
• Difficulty: ${metrics.network_difficulty ?? '—'}
• Response Time: ${metrics.avg_response_ms ? `${Math.round(metrics.avg_response_ms)}ms` : '—'}`;
      }

      // Optional: decisions history -> can feed the chat or a future table
      const decisions = await fetchJSON(endpoints.decisions, null);
      if (decisions && Array.isArray(decisions)) {
        window.__xmrtHealthCache = `Recent Decisions:\n` +
          decisions.slice(0, 5).map(d => `• ${d.id ?? 'n/a'} — ${d.status ?? 'unknown'}`).join('\n');
      }
    }

    function setText(id, v) { const el = document.getElementById(id); if (el) el.textContent = String(v); }
    function formatMaybeHashrate(h) {
      if (!Number.isFinite(h)) return '—';
      if (h >= 1e9) return (h/1e9).toFixed(1) + ' GH/s';
      if (h >= 1e6) return (h/1e6).toFixed(1) + ' MH/s';
      if (h >= 1e3) return (h/1e3).toFixed(1) + ' KH/s';
      return Math.round(h) + ' H/s';
    }

    // Pulse dots + initial hydrate + refresh loop
    setInterval(() => {
      document.querySelectorAll('.status-dot').forEach(dot => {
        dot.style.opacity = dot.style.opacity === '0.5' ? '1' : '0.5';
      });
    }, 2000);

    document.addEventListener('DOMContentLoaded', hydrateFromAPI);
    setInterval(hydrateFromAPI, 15_000); // refresh every 15s
  </script>
</body>
</html>

